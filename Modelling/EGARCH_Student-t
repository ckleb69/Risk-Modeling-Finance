import warnings
warnings.filterwarnings("ignore")

import os
import numpy as np
import pandas as pd
from arch import arch_model
from statsmodels.stats.diagnostic import acorr_ljungbox

# -------- Paths --------
IN_PATH  = r"C:\Kurtay Finance Project\Data\CLEANWRDS.csv"
OUT_PATH = r"C:\Kurtay Finance Project\Results\EGARCH_studentt_only.csv"
os.makedirs(os.path.dirname(OUT_PATH), exist_ok=True)

# -------- Tickers --------
tech = ["AAPL","MSFT","INTC","CSCO","IBM","ORCL","NVDA","XRX","ADBE","QCOM","HPQ","ADP"]
ind  = ["GE","MMM","CAT","DE","HON","UPS","FDX","UNP","BA","LMT","PH","EMR"]
tickers = tech + ind


# -------- Helper functions --------
def preprocess_series(s: pd.Series, min_len=250):
    """Percent-scale, gentle winsorization, ensure variance."""
    x = pd.to_numeric(s, errors='coerce').dropna() * 100
    if len(x) < min_len:
        return pd.Series(dtype=float)
    lo, hi = x.quantile(0.005), x.quantile(0.995)
    x = x.clip(lo, hi)
    if x.std(ddof=1) == 0 or not np.isfinite(x.std()):
        return pd.Series(dtype=float)
    return x


def lb_pvalues(std_resid: np.ndarray, lags=10):
    r = pd.Series(std_resid).dropna()
    if len(r) < lags + 5:
        return np.nan, np.nan
    lb_r  = acorr_ljungbox(r, lags=[lags], return_df=True)['lb_pvalue'].iloc[-1]
    lb_sr = acorr_ljungbox(r**2, lags=[lags], return_df=True)['lb_pvalue'].iloc[-1]
    return float(lb_r), float(lb_sr)


# -------- Main loop --------
df = pd.read_csv(IN_PATH)
results, failed = [], []

print("\nðŸš€ EGARCH(1,1) Student-t (no GED/Normal) ...\n")

for t in tickers:
    print(f"================ {t} ================")
    x = preprocess_series(df.loc[df['ticker'] == t, 'log_ret'])

    if x.empty:
        print(f"âš ï¸ {t}: insufficient usable data.")
        failed.append((t, "preprocess"))
        continue

    try:
        # Stage-1: initialize with Î½ = 8 as starting value
        am = arch_model(x, vol='EGARCH', p=1, q=1, mean='Constant', dist='studentst', rescale=True)
        start_vals = None

        # Create a starting vector with nu=8 if not automatically included
        try:
            # first fit quick normal EGARCH to get starting params (stable base)
            am_norm = arch_model(x, vol='EGARCH', p=1, q=1, mean='Constant', dist='normal', rescale=True)
            res_norm = am_norm.fit(disp='off', tol=1e-4)
            start_vals = res_norm.params.copy()
            start_vals['nu'] = 8.0  # add Student-t df start
            start_vals = start_vals.to_numpy()
        except Exception:
            pass

        res = am.fit(starting_values=start_vals, disp='off', tol=1e-5, show_warning=False)

        # --- Extract parameters ---
        params = res.params
        mu, omega = params.get('mu', np.nan), params.get('omega', np.nan)
        alpha, beta = params.get('alpha[1]', np.nan), params.get('beta[1]', np.nan)
        nu = params.get('nu', np.nan)
        persistence = beta  # correct for EGARCH

        lb_r, lb_sr = lb_pvalues(res.std_resid, lags=10)

        results.append({
            'ticker': t,
            'dist': 'studentt',
            'mu': mu,
            'omega': omega,
            'alpha[1]': alpha,
            'beta[1]': beta,
            'nu': nu,
            'persistence_beta': persistence,
            'logL': res.loglikelihood,
            'aic': res.aic,
            'bic': res.bic,
            'LB_pval_resid': lb_r,
            'LB_pval_sqresid': lb_sr,
            'n_obs': int(res.nobs),
            'convergence_flag': getattr(res, 'convergence_flag', 'unknown')
        })

        nu_str = f"{nu:.2f}" if np.isfinite(nu) else "â€”"
        print(f"âœ… {t}: Î²={persistence:.3f}, Î½={nu_str}, LBp={lb_r:.3f}/{lb_sr:.3f}")

    except Exception as e:
        print(f"âŒ {t}: EGARCH-Student-t failed â†’ {e}")
        failed.append((t, str(e)))
        continue


# -------- Save results --------
res_df = pd.DataFrame(results)
res_df.to_csv(OUT_PATH, index=False)

print(f"\nâœ… Saved results to: {OUT_PATH}")
print(f"âœ… Successful fits: {len(results)} | âŒ Failures: {len(failed)}")
if failed:
    print("Failed tickers:")
    for t, why in failed:
        print(f" - {t}: {why}")

if not res_df.empty:
    print("\nHead of results:")
    print(res_df.head())