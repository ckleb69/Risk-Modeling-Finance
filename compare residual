import os
import numpy as np
import pandas as pd
from math import log, pi
from scipy.special import gamma
from scipy.optimize import minimize

# ===============================================================
# Paths
# ===============================================================
BASE = r"C:\Kurtay Finance Project\Data"
RESID_DIR = os.path.join(BASE, "Student_Residuals")   # <-- z_t residuals folder
OUT_FILE  = os.path.join(BASE, "ResidualOnly_AICBIC_Normal_t_PVII.csv")

# ===============================================================
# Distribution log-likelihoods
# ===============================================================
def ll_normal(z):
    """Log-likelihood for standard Normal(0,1)."""
    return -0.5 * np.sum(z**2 + log(2*pi))

def ll_student_t(z, nu):
    """Log-likelihood for standardized Student-t."""
    c = gamma((nu + 1) / 2) / (np.sqrt(nu * pi) * gamma(nu / 2))
    return np.sum(np.log(c) - ((nu + 1) / 2) * np.log(1 + z**2 / nu))

def ll_pearson7(z, m, scale):
    """Log-likelihood for Pearson-VII with loc=0."""
    coef = gamma(m) / (scale * np.sqrt(pi) * gamma(m - 0.5))
    return np.sum(np.log(coef) - m * np.log(1 + (z / scale)**2))

# ===============================================================
# MLE wrappers
# ===============================================================
def mle_student_t(z):
    def nll(nu):
        if nu <= 2: return 1e20
        return -ll_student_t(z, nu)
    res = minimize(lambda x: nll(x[0]), x0=[8.0], bounds=[(2.01, 200)], method="L-BFGS-B")
    return res.x[0], -res.fun, res.success

def mle_pearson7(z):
    def nll(params):
        m, s = params
        if m <= 1 or s <= 1e-8: return 1e20
        return -ll_pearson7(z, m, s)
    init = np.array([3.0, np.std(z)])
    bounds = [(1.001, 200.0), (1e-6, 1e3)]
    res = minimize(nll, init, bounds=bounds, method="L-BFGS-B")
    m, s = res.x
    return m, s, -res.fun, res.success

# ===============================================================
# Main loop
# ===============================================================
files = [f for f in os.listdir(RESID_DIR) if f.endswith("_resid.csv")]
rows = []

print(f"\nðŸš€ Running residual-only Normal / Student-t / Pearson-VII comparison on {len(files)} tickers...\n")

for f in files:
    tkr = f.replace("_resid.csv", "")
    try:
        z = pd.read_csv(os.path.join(RESID_DIR, f))["std_resid"].dropna().to_numpy()
        n = len(z)
        if n < 50:
            print(f"âš ï¸ {tkr}: insufficient residuals ({n})")
            continue

        # ---------- Normal ----------
        llN = ll_normal(z); kN = 0
        aicN = 2*kN - 2*llN
        bicN = kN*np.log(n) - 2*llN

        # ---------- Student-t ----------
        nu, llT, okT = mle_student_t(z); kT = 1
        aicT = 2*kT - 2*llT
        bicT = kT*np.log(n) - 2*llT

        # ---------- Pearson-VII ----------
        m, s, llP, okP = mle_pearson7(z); kP = 2
        aicP = 2*kP - 2*llP
        bicP = kP*np.log(n) - 2*llP

        # ---------- Determine best ----------
        aics = {"Normal": aicN, "StudentT": aicT, "PearsonVII": aicP}
        bics = {"Normal": bicN, "StudentT": bicT, "PearsonVII": bicP}
        bestA = min(aics, key=aics.get)
        bestB = min(bics, key=bics.get)

        rows.append({
            "ticker": tkr, "n": n,
            "nu_hat": nu, "m_hat": m, "scale_hat": s,
            "logL_Normal": llN, "AIC_Normal": aicN, "BIC_Normal": bicN,
            "logL_StudentT": llT, "AIC_StudentT": aicT, "BIC_StudentT": bicT,
            "logL_PearsonVII": llP, "AIC_PearsonVII": aicP, "BIC_PearsonVII": bicP,
            "Best_AIC": bestA, "Best_BIC": bestB,
            "Î”AIC_t_norm": aicT - aicN, "Î”AIC_p7_t": aicP - aicT,
            "ok_t": okT, "ok_p7": okP
        })

        print(f"âœ… {tkr}: best(AIC)={bestA}, Î”AIC_t_norm={aicT - aicN:.1f}, Î”AIC_p7_t={aicP - aicT:.1f}")

    except Exception as e:
        print(f"âŒ {tkr}: failed â€” {e}")

# ===============================================================
# Save results
# ===============================================================
out = pd.DataFrame(rows)
out.to_csv(OUT_FILE, index=False)

print(f"\nðŸ’¾ Saved residual-only comparison to:\n{OUT_FILE}")
print(f"âœ… Successful fits: {len(out)}")

# Optional summary
if len(out) > 0:
    print("\nðŸ“Š Model win counts (AIC):")
    print(out["Best_AIC"].value_counts(), "\n")

    print("ðŸ“‰ Mean Î”AIC (t-Normal):", np.nanmean(out["Î”AIC_t_norm"]))
    print("ðŸ“‰ Mean Î”AIC (PearsonVII-t):", np.nanmean(out["Î”AIC_p7_t"]))